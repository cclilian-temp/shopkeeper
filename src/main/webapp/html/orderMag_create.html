<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title> - 客户管理</title>
    <meta name="keywords" content="">
    <meta name="description" content="">

    <link rel="shortcut icon" href="favicon.ico"> <link href="../css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="../css/font-awesome.css?v=4.4.0" rel="stylesheet">

    <link href="../css/animate.css" rel="stylesheet">
    <link href="../css/style.css?v=4.1.0" rel="stylesheet">

    <!-- Data Tables -->
    <link href="../css/plugins/dataTables/dataTables.bootstrap.css" rel="stylesheet">
    
    <style type="text/css"> 
        table.dataTable tbody tr.selected {
            background-color: #b0bed9;
        }
    </style>
</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content  animated fadeInRight">
        <div class="row">
            <div class="col-sm-8">
                <div class="ibox float-e-margins">
                    <div class="ibox-content">
                        <div class="tabs-container">
                            <ul class="nav nav-tabs">
                                <li class="active">
                                    <a data-toggle="tab" href="#tab-1" aria-expanded="true"> 添加单品</a>
                                </li>
                                <li class="">
                                    <a data-toggle="tab" href="#tab-2" aria-expanded="false"> 添加套餐</a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <!-- 添加单品Tab -->
                                <div id="tab-1" class="tab-pane active">
                                    <div class="panel-body">
                                        <form method="get" class="form-horizontal">
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">单品型号</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="productionModel_search"> 
                                                            <span class="input-group-btn"> 
                                                                <button id="query-product" type="button" class="btn btn-primary" onclick="searchProduction()">搜索</button> 
                                                            </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="hr-line-dashed"></div>
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">折扣</label>
                                                <div class="col-sm-4">
                                                    <input type="text" class="form-control" id="productionDiscount">
                                                </div>
                                                <label class="col-sm-2 control-label">数量</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="productionNum"> 
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">备注</label>
                                                <div class="col-sm-10">
                                                    <textarea name="comment" class="form-control" required="" aria-required="true" id="productionRemark"></textarea>
                                                </div>
                                            </div>
                                            <div class="hr-line-dashed"></div>
                                            <div class="form-group">
                                                <div class="col-sm-4 col-sm-offset-2">
                                                    <button class="btn btn-primary" type="button" onclick="addProduction()">添加单品</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <!-- 添加套系Tab -->
                                <div id="tab-2" class="tab-pane">
                                    <div class="panel-body">
                                        <form method="get" class="form-horizontal">
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">套系型号</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="groupModel_search"> 
                                                            <span class="input-group-btn"> 
                                                                <button id="query-group" type="button" class="btn btn-primary" onclick="searchGroup()">搜索</button> 
                                                            </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="hr-line-dashed"></div>
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">数量</label>
                                                <div class="col-sm-4">
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="groupNum"> 
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-sm-2 control-label">备注</label>
                                                <div class="col-sm-10">
                                                    <textarea name="comment" class="form-control" required="" aria-required="true" id="groupRemark"></textarea>
                                                </div>
                                            </div>
                                            <div class="hr-line-dashed"></div>
                                            <div class="form-group">
                                                <div class="col-sm-4 col-sm-offset-2">
                                                    <button class="btn btn-primary" type="button" onclick="addGroup()">添加套系</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ibox float-e-margins">
                    <div class="ibox-content">
                        <div class="">
                            <div class="col-sm-6">
                                <button id="button" type="button" class="btn btn-primary">
                                    删除
                                </button>
                            </div>
                            <div class="col-sm-3 col-sm-offset-3">
                                <a class="btn btn-primary" role="button" onclick="createOrder()">提交订单</a>
                                <button class="btn btn-white" onclick="history.go(-1)">取消</button>
                            </div>
                            
                        </div>
                        <table class="table table-striped table-bordered table-hover " id="editable">
                            <thead>
                                <tr>
                                    <th>型号</th>
                                    <th>分类</th>
                                    <th>单价</th>
                                    <th>数量</th>
                                    <th>折扣</th>
                                    <th>备注</th>
                                </tr>
                            </thead>
                            <tbody>
                                
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <!-- 单品信息 -->
                <div id="production-info" class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>单品信息</h5>
                    </div>
                    <div class="ibox-content">
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label class="col-sm-4 control-label">型号：</label>
                                <div class="col-sm-8">
                                    <input type="text" readonly="readonly" class="form-control" id="productionModel"> 
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label">分类：</label>
                                <div class="col-sm-8">
                                    <input type="text" readonly="readonly" class="form-control" id="productionType"> 
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label">单价：</label>
                                <div class="col-sm-8">
                                    <input type="text" readonly="readonly" class="form-control" id="productionPrice"> 
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-4 control-label">是否特价：</label>
                                <div class="col-sm-8">
                                    <input type="text" readonly="readonly" class="form-control" id="productionIsSpecial"> 
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-8">
                                    <input type="text" readonly="readonly" class="form-control" style="display: none;" id="productionSpecialDiscount">
                                    <input type="text" readonly="readonly" class="form-control" style="display: none;" id="productionLowestDiscount"> 
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- 套系信息 -->
                <div id="group-info" style="display: none;" class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>套系信息</h5>
                    </div>
                    <div class="ibox-content">
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">型号：</label>

                                <div class="col-sm-8">
                                    <input  placeholder="用户名" class="form-control" id="groupModel"> 
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">价格：</label>
                                <div class="col-sm-8">
                                    <input  placeholder="密码" class="form-control" id="groupPrice">
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <div class="table-responsive m-t">
                                        <table class="table invoice-table" id="groupProductiontable">
                                            <thead>
                                                <tr>
                                                    <th>清单</th>
                                                    <th>数量</th>
                                                    <th>单价</th>
                                                    <th>总价</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 全局js -->
    <script src="../js/jquery.min.js?v=2.1.4"></script>
    <script src="../js/bootstrap.min.js?v=3.3.6"></script>

    <script src="../js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

    <!-- 自定义js -->
    <script src="../js/content.js?v=1.0.0"></script>

    <script src="../js/plugins/jeditable/jquery.jeditable.js"></script>

    <!-- Data Tables -->
    <script src="../js/plugins/dataTables/jquery.dataTables.js"></script>
    <script src="../js/plugins/dataTables/dataTables.bootstrap.js"></script>

    <script>
        /*$(function () {
            $('.full-height-scroll').slimScroll({
                height: '100%'
            });
        });*/

        $(document).ready(function () {
          
            /* Init DataTables */
            $('#editable').dataTable({
                "paging":   false,
                "ordering": false,
                "searching": false,
                "info":     false 
            });

            var table = $('#editable').DataTable();

            $('#editable tbody').on( 'click', 'tr', function () {
                if ( $(this).hasClass('selected') ) {
                    $(this).removeClass('selected');
                }
                else {
                    table.$('tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                }
            } );
         
            $('#button').click( function () {
                table.row('.selected').remove().draw( false );
            } );

            /* 单品Tab页 搜索按钮 */
            $('#query-product').click( function () {
                $("#production-info").show();
                $("#group-info").hide();
            });

            /* 套系Tab页 搜索按钮 */
            $('#query-group').click( function () {
                $("#production-info").hide();
                $("#group-info").show();
            } );

        });
        
        function searchProduction(){
        	var productionModel_search = $('#productionModel_search').val();
        	if(!productionModel_search){
        		alert("查询产品型号不能为空");
        		return;
        	}
        	var url = '/ws/production/list?model=' + productionModel_search;
        	$.ajax({
				async: false,
				url: url,
				type: "GET",
				dataType: "json",
				success: function(data){
					if(data.code == 1) {
						var productions = new Array();
						productions = data.data;
						
						if(productions.length <= 0){
							alert("不存在该产品");
							return;
						}
						var model = productions[0].model;
						var type = productions[0].type;
						var price = productions[0].price;
						var lowestDiscount = productions[0].lowestDiscount;
						var specialDiscount = productions[0].specialDiscount;
						var isSpecial = "";
			        	
			        	if(lowestDiscount > specialDiscount) {
			        		isSpecial = "是";
			        	}else{
			        		isSpecial = "否";
			        	}
						
						document.getElementById("productionModel").value=model;
			        	document.getElementById("productionType").value=type;
			        	document.getElementById("productionPrice").value=price;
			        	document.getElementById("productionIsSpecial").value=isSpecial;
			        	document.getElementById("productionSpecialDiscount").value=specialDiscount;
			        	document.getElementById("productionLowestDiscount").value=lowestDiscount;
					} else {
						var msg = data.message;
						alert(msg);
					}
				},
				dataType:"json",
        	});
        }
        
        function searchGroup(){
        	var groupModel_search = $('#groupModel_search').val();
        	if(!groupModel_search){
        		alert("查询产品型号不能为空");
        		return;
        	}
        	var url = '/ws/group/groupProduction?model=' + groupModel_search;
        	$.ajax({
				async: false,
				url: url,
				type: "GET",
				dataType: "json",
				success: function(data){
					if(data.code == 1) {
						group = data.data;
						if(!group){
							alert("不存在该套系");
							return;
						}
						
						var model = group.model;
						var price = group.price;
						
						document.getElementById("groupModel").value=model;
						document.getElementById("groupPrice").value=price;
						
						var productions = new Array();
						productions = group.productions;
						
						$('#groupProductiontable').dataTable().fnClearTable()
						
						for(var i in productions){
							var productionModel = productions[i].model;
							var productionNum = parseInt(productions[i].num);
							var productionPrice = parseFloat(productions[i].price);
							var productionPriceSum = productionNum*productionPrice;
							
							$('#groupProductiontable').dataTable().fnAddData([productionModel,productionNum,productionPrice,productionPriceSum]);
						}
					} else {
						var msg = data.message;
						alert(msg);
					}
				},
				dataType:"json",
        	});
        }
        
        function addProduction(){
        	var productionModel = $('#productionModel_search').val();
        	var productionType = $('#productionType').val();
        	var productionPrice = $('#productionPrice').val();
        	var productionNum = $('#productionNum').val();
        	var productionDiscount = $('#productionDiscount').val();
        	var productionRemark = $('#productionRemark').val();
        	//var operator = '<a href="#" data-toggle="modal" data-target="#myModal"><i class="fa fa-edit text-navy"></i></a>';
        	
        	//判断价格逻辑
        	var productionLowestDiscount = $('#productionLowestDiscount').val();
        	var productionSpecialDiscount = $('#productionSpecialDiscount').val();
        	if(!productionModel){
        		alert("单品型号不能为空");
        		return;
        	}
        	if(!productionDiscount){
        		alert("单品折扣不能为空");
        		return;
        	}
        	if(!productionNum){
        		alert("单品数量不能为空");
        		return;
        	}
        	/* if(productionDiscount < productionLowestDiscount) {
        		alert("折扣不能低于单品最低折扣");
        		return;
        	} */
        	if(productionDiscount < productionSpecialDiscount) {
        		alert("折扣不能低于单品最低折扣");
        		return;
        	}
        	$('#editable').dataTable().fnAddData([
                productionModel,
                productionType,
                productionPrice,
                productionNum,
                productionDiscount,
                productionRemark]);
        }
        
        function addGroup(){
        	var groupModel = $('#groupModel_search').val();
        	var groupPrice = $('#groupPrice').val();
        	var groupNum = $('#groupNum').val();
        	var groupRemark = $('#groupRemark').val();
        	//var operator = '<a href="#" data-toggle="modal" data-target="#myModal"><i class="fa fa-edit text-navy"></i></a>';
        	if(!groupNum){
        		alert("套系数量不能为空");
        		return;
        	}
        	if(!groupPrice){
        		alert("套系价格不能为空");
        		return;
        	}
        	if(!groupModel){
        		alert("套系型号不能为空");
        		return;
        	}
        	$('#editable').dataTable().fnAddData([
    	                                      groupModel,
    	                                      "套系",
    	                                      groupPrice,
    	                                      groupNum,
    	                                      10,
    	                                      groupRemark]);
        }
        
        function createOrder(){
        	var groups = new Array();
        	var productions = new Array();
        	
        	var itemRows = document.getElementById("editable");
        	m=0;
        	n=0
        	for(i = 1 ; i < itemRows.rows.length ; i++){
        		if(itemRows.rows[i].cells.length > 0){
        			var model = itemRows.rows[i].cells[0].innerHTML;
        			var type = itemRows.rows[i].cells[1].innerHTML;
        			var price = itemRows.rows[i].cells[2].innerHTML;
        			var num = itemRows.rows[i].cells[3].innerHTML;
        			var discount = itemRows.rows[i].cells[4].innerHTML;
        			var remark = itemRows.rows[i].cells[5].innerHTML;
        			if(type == "套系"){
        				var group = new Object();
        				group.model = model;
        				group.price = price;
        				group.num = num;
        				var remarkObj = new Object();
        				remarkObj.clientMessage = remark;
        				
        				group.remark = remarkObj;
        				groups[m] = group;
        				m++;
        			}else {
        				var production = new Object();
        				production.model = model;
        				production.type = type;
        				production.price = price;
        				production.num = num;
        				var remarkObj = new Object();
        				remarkObj.clientMessage = remark;
        				
        				production.remark = remarkObj;
        				production.discount = discount;
        				productions[n] = production;
        				n++;
        			}
        		}
        	}
        	
        	var orderInfo = new Object();
        	orderInfo.productionInfos = productions;
        	orderInfo.groupInfos = groups;
        	
        	var data = JSON.stringify(orderInfo);
        	var url = "/ws/order/submit";
        	$.ajax({
				async: false,
				url: url,
				type: 'POST',
				contentType: 'application/json',
				data: data,
				success: function(data, textStatus, jqXHR) {
					if(data.code == 1) {
						var id = data.data;
						
						window.location.href="orderMag_confirm.html?orderId="+id;
						//$.toast({text:'提交成功',type:'success',position:'center'});
					} else {
						var msg = data.msg;
						alert(msg);
						//$.toast({text:msg,type:'danger',position:'center'});
					}
				},
				
			});
        }
        
        
    </script>

    
    

</body>

</html>
