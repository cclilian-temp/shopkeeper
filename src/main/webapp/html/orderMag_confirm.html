<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title> - 基本表单</title>
    <meta name="keywords" content="">
    <meta name="description" content="">

    <link rel="shortcut icon" href="favicon.ico"> <link href="../css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="../css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="../css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="../css/animate.css" rel="stylesheet">
    <link href="../css/style.css?v=4.1.0" rel="stylesheet">

    <style type="text/css"> 
        td.details-control {
            /* background: url('../resources/details_open.png') no-repeat center center; */
            cursor: pointer;
        }
        tr.shown td.details-control {
            /* background: url('../resources/details_close.png') no-repeat center center; */
        }
    </style>
</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-content">
                		<div class="pull-right tooltip-demo">
                            <span class="label label-danger">订单编号</span>
                            <input type="text" class="form-control" id="orderId">
                        </div>
                        <h1>香港华师傅专卖店</h1>
                		<div class="hr-line-dashed"></div>
                        <form method="get" class="form-horizontal">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">店铺名称</label>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control" id="storeName">
                                </div>
                                <label class="col-sm-2 control-label">店铺地址</label>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control" id="storeAddress">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">电话</label>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control" id="storeTel">
                                </div>
                                <label class="col-sm-2 control-label">传真</label>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control" id="storeFax">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
							<div class="form-group">
                                <label class="col-sm-2 control-label">客户姓名</label>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control" id="clientName">
                                </div>
                                <label class="col-sm-2 control-label">电话</label>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control" id="clientTel">
                                </div>
                            </div>
							<div class="form-group">
                                <label class="col-sm-2 control-label">送货地址</label>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control" id="clientAddress">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">总商品金额</label>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control" id="priceTotal">
                                </div>
                                <label class="col-sm-2 control-label">应付金额</label>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control" id="priceNeeded">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">实付定金金额</label>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control" id="prepaid">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">备注</label>
                                <div class="col-sm-10">
                                    <textarea name="comment" class="form-control" required="" aria-required="true" id="orderRemark"></textarea>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-sm-4 col-sm-offset-2">
                                    <!-- <button class="btn btn-primary" type="submit">确认订单</button> -->
                                    <a href="print_preview.html" class="btn btn-primary" role="button" onclick="confirmOrder()">确认订单</a>
                                    <button class="btn btn-white" type="submit">取消</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-content">
                        <table class="table table-striped table-bordered table-hover " id="example">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>型号</th>
                                    <th>分类</th>
                                    <th>单价</th>
                                    <th>数量</th>
                                    <th>小计</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 全局js -->
    <script src="../js/jquery.min.js?v=2.1.4"></script>
    <script src="../js/bootstrap.min.js?v=3.3.6"></script>

    <!-- 自定义js -->
    <script src="../js/content.js?v=1.0.0"></script>

    <!-- Data Tables -->
    <script src="../js/plugins/dataTables/jquery.dataTables.js"></script>
    <script src="../js/plugins/dataTables/dataTables.bootstrap.js"></script>

    <!-- iCheck -->
    <script src="../js/plugins/iCheck/icheck.min.js"></script>
    
    <!-- Page-Level Scripts -->
    <script>
    /* Formatting function for row details - modify as you need */
        function format (groupProductions) {
    		alert(JSON.stringify(groupProductions));
    	
    		var dataTableM = '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">';
    		var groupProductionInfos = new Array();
    		groupProductionInfos = groupProductions.other;
    		for(var i in groupProductionInfos){
    			dataTableM = dataTableM + '<tr>'+
	                '<td style="width:100px">单品型号:</td>'+
	                '<td style="width:100px">'+groupProductionInfos[i].productionModel+'</td>'+
	                '<td style="width:100px">单品数量:</td>'+
	                '<td style="width:100px">'+groupProductionInfos[i].num+'</td>'+
	            '</tr>';
    		}
    		dataTableM = dataTableM + '</table>';
            return dataTableM;
        }
        $(document).ready(function() {
            var thisURL = document.URL;
            var  getval =thisURL.split('?')[1];
            var orderId= getval.split("=")[1];
            
            var url = "/ws/order/orderInfo?id="+orderId;
            
            
            $.ajax({
				async: false,
				url: url,
				type: "GET",
				dataType: "json",
				success: function(data){
					if(data.code == 1) {
						var orderInfo = data.data;
						var priceInfo = orderInfo.priceInfo;
						var productionInfos = orderInfo.productionInfos;
						var groupInfos = orderInfo.groupInfos;
						var message = orderInfo.message;
						//添加价格信息
						var priceTotal = priceInfo.priceTotal;
						var priceNeeded = priceInfo.priceNeeded;
						document.getElementById("priceTotal").value=priceTotal;
			        	document.getElementById("priceNeeded").value=priceNeeded;
			        	document.getElementById("orderId").value=orderId;
			        	document.getElementById("orderRemark").value=message;
			        	//$('#example').dataTable().fnClearTable()
			        	
			        	var msg = new Array();
			        	n=0;
			        	//添加单品信息
			        	for(var i in productionInfos){
			        		var obj = new Object();
			        		var model = productionInfos[i].model;
			        		var type = productionInfos[i].type;
			        		var price = productionInfos[i].price;
			        		var num = productionInfos[i].num;
			        		var subTotal = productionInfos[i].subTotal;
			        		obj.model = model;
			        		obj.type = type;
			        		obj.price = price;
			        		obj.num = num;
			        		obj.subTotal = subTotal;
			        		obj.other = null;
			        		msg[n] = obj;
			        		n++;
			        	}
			        	//添加套系信息
						for(var j in groupInfos){
							var obj = new Object();
							var model = groupInfos[j].model;
							var type = "套系";
							var price = groupInfos[j].price;
							var num = groupInfos[j].num;
							var subtotal = groupInfos[j].subtotal;
							obj.model = model;
			        		obj.type = type;
			        		obj.price = price;
			        		obj.num = num;
			        		obj.subtotal = subtotal;
			        		
			        		
							var groupProductions = new Array();
							groupProductions = groupInfos[j].remark.groupProductions;
							obj.other = groupProductions;
							
							msg[n]=obj;
							n++;
						}
						
						var table = $('#example').DataTable( {
			                "data": msg,
			                "columns": [
			                    {
			                        "class":          'details-control',
			                        "orderable":      false,
			                        "data":           null,
			                        "defaultContent": ''
			                    },
			                    { "data": "model" },
			                    { "data": "type" },
			                    { "data": "price" },
			                    { "data": "num" },
			                    { "data": "subtotal" }
			                ],
			                "paging":   false,
			                "ordering": false,
			                "searching": false,
			                "info":     false 
			            });
						$('#example tbody').on( 'click', 'tr', function () {
			                var tr = $(this).closest('tr');
			                var row = table.row( tr );
			         
			                
			                // Open this row
			                if(row.data().other == null) {

			                } else {
				                row.child( format(row.data()) ).show();
				               	tr.addClass('shown');
			                }
			            } );

			            $('#example tr').click();
					} else {
						var msg = data.message;
						alert(msg);
   					//$.toast({text:msg,type:'danger',position:'center'});
					}
				},
				dataType:"json",
       		});
        } );
        
        
        function confirmOrder(){
        	var orderId = $('#orderId').val();
        	
        	/* var storeName = $('#storeName').val();
        	var storeAddress = $('#storeAddress').val();
        	var storeTel = $('#storeTel').val();
        	var storeFax = $('#storeFax').val(); */
        	
        	var clientName = $('#clientName').val();
        	var clientTel = $('#clientTel').val();
        	var clientAddress = $('#clientAddress').val();
        	
        	var prepaid = $('#prepaid').val();
        	/* var priceTotal = $('#priceTotal').val();
        	var priceNeeded = $('#priceNeeded').val(); */
        	
        	var orderRemark = $('#orderRemark').val();
        	
        	var orderInfo = new Object();
        	
        	var clientInfo = new Object();
        	clientInfo.name = clientName;
        	clientInfo.tel = clientTel;
        	clientInfo.address = clientAddress;
        	
        	var priceInfo = new Object();
        	priceInfo.prepaid = prepaid;
        	
        	orderInfo.id = orderId;
        	orderInfo.clientInfo = clientInfo;
        	orderInfo.priceInfo = priceInfo;
        	orderInfo.message = orderRemark;
        	
        	var data = JSON.stringify(orderInfo);
        	var url = "/ws/order/confirm";
        	$.ajax({
				async: false,
				url: url,
				type: 'POST',
				contentType: 'application/json',
				data: data,
				success: function(data, textStatus, jqXHR) {
					if(data.code == 1) {
						var id = data.data;
						alert("提交成功");
						//window.location.href="orderMag_confirm.html?orderId="+id;
						//$.toast({text:'提交成功',type:'success',position:'center'});
					} else {
						var msg = data.msg;
						alert(msg);
						//$.toast({text:msg,type:'danger',position:'center'});
					}
				},
				
			});
        }
    </script>
</body>

</html>