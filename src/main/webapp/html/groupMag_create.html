<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <title> - 基本表单</title>
    <meta name="keywords" content="">
    <meta name="description" content="">

    <link rel="shortcut icon" href="favicon.ico"> <link href="../css/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="../css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="../css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="../css/animate.css" rel="stylesheet">
    <link href="../css/style.css?v=4.1.0" rel="stylesheet">
    <style type="text/css"> 
        table.dataTable tbody tr.selected {
            background-color: #b0bed9;
        }
    </style>
</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-content">
                        <form method="get" class="form-horizontal">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">套系型号</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="groupModel">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">优惠价格</label>
                               <div class="col-sm-10">
                                    <input type="text" class="form-control" id="groupPrice">
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">单品查询</label>
                                <div class="col-sm-10">
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="请输入单品型号" id="productionModel_search"> 
                                        	<span class="input-group-btn"> 
                                        		<button type="button" class="btn btn-primary" data-toggle="modal"  onclick="searchProduction()">搜索</button> 
                                        	</span>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">产品清单</label>
                                <div class="col-sm-10">
                                    <div class="ibox float-e-margins">
					                    <div class="ibox-content">
                                            <div class="">
                                                <div class="col-sm-6">
                                                    <button id="button" type="button" class="btn btn-primary">
                                                        删除
                                                    </button>
                                                </div>
                                            </div>
					                        <table class="table table-striped table-bordered table-hover " id="editable">
					                            <thead>
					                                <tr>
					                                    <th>型号</th>
					                                    <th>特价折扣</th>
					                                    <th>单品数量</th>
					                                </tr>
					                            </thead>
					                            <tbody>
					                            </tbody>
					                        </table>
					                    </div>
					                </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <div class="col-sm-4 col-sm-offset-2">
                                    <button class="btn btn-primary" type="submit" onclick="createGroup()">保存内容</button>
                                    <button class="btn btn-white" onclick="history.go(-1)">取消</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal inmodal" id="productionModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content animated bounceInRight">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">关闭</span>
                    </button>
                    <lable class="modal-title">单品信息</lable>
                </div>
                <div class="modal-body">
                    <form role="form" class="form-horizontal m-t">
                        <div class="form-group">
                            <label class="col-sm-3 control-label">型号：</label>
                            <div class="col-sm-8">
                                <input type="text" name="" placeholder="" class="form-control" id="productionModel" readonly="true">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">分类：</label>
                            <div class="col-sm-8">
                                <input type="text" name="" placeholder="" class="form-control" id="productionType" readonly="true">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">单价：</label>
                            <div class="col-sm-8">
                                <input type="text" name="" placeholder="" class="form-control" id="productionPrice" readonly="true">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">最低折扣：</label>
                            <div class="col-sm-8">
                                <input type="text" name="" placeholder="" class="form-control" id="productionLowestDiscount" readonly="true">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">特价折扣：</label>
                            <div class="col-sm-8">
                                <input type="text" name="" placeholder="请输入文本" class="form-control" id="productionSpecialDiscount">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label">单品数量：</label>
                            <div class="col-sm-8">
                                <input type="text" name="" placeholder="请输入文本" class="form-control" id="productionNum">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="fnClickAddRow();">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 全局js -->
    <script src="../js/jquery.min.js?v=2.1.4"></script>
    <script src="../js/bootstrap.min.js?v=3.3.6"></script>

    <!-- 自定义js -->
    <script src="../js/content.js?v=1.0.0"></script>

    <script src="../js/plugins/jeditable/jquery.jeditable.js"></script>

    <!-- Data Tables -->
    <script src="../js/plugins/dataTables/jquery.dataTables.js"></script>
    <script src="../js/plugins/dataTables/dataTables.bootstrap.js"></script>
    <script>
        $(document).ready(function () {
          
            /* Init DataTables */
            $('#editable').dataTable({
                "paging":   false,
                "ordering": false,
                "searching": false,
                "info":     false 
            });

            var table = $('#editable').DataTable();

            $('#editable tbody').on( 'click', 'tr', function () {
                if ( $(this).hasClass('selected') ) {
                    $(this).removeClass('selected');
                }
                else {
                    table.$('tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                }
            } );
         
            $('#button').click( function () {
                table.row('.selected').remove().draw( false );
            } );

        });

        function fnClickAddRow() {
        	var productionModel = $('#productionModel').val();
        	var productionSpecialDiscount = $('#productionSpecialDiscount').val();
        	var productionNum = $('#productionNum').val();
        	var productionLowestDiscount = $('#productionLowestDiscount').val();
        	
        	if(!productionModel){
        		alert("单品型号不能为空");
        		return;
        	}
        	if(!productionSpecialDiscount){
        		alert("单品特价折扣不能为空");
        		return;
        	}
        	if(!productionNum){
        		alert("单品数量不能为空");
        		return;
        	}
        	if(parseFloat(productionSpecialDiscount) > parseFloat(productionLowestDiscount)){
        		alert("单品特价折扣不能高于单品最低折扣");
        		return;
        	}
        	
            $('#editable').dataTable().fnAddData([
                productionModel,
                productionSpecialDiscount,
                productionNum]);
            $('#productionModal').modal('hide');
        }
        
        function searchProduction(){
        	var productionModel = $('#productionModel_search').val();
        	if(!productionModel){
        		alert("查询产品型号不能为空");
        		return;
        	}
        	var url = '/ws/production/list?' + 'model=' + productionModel + '&type=' + "";
        	$.ajax({
				async: false,
				url: url,
				type: "GET",
				dataType: "json",
				success: function(data){
					if(data.code == 1) {
						var productions = new Array();
						productions = data.data;
						
						if(productions.length <= 0){
							alert("不存在该产品");
							return;
						}
						var model = productions[0].model;
						var type = productions[0].type;
						var price = productions[0].price;
						var lowestDiscount = productions[0].lowestDiscount;
						var specialDiscount = productions[0].specialDiscount;
						
						document.getElementById("productionModel").value=model;
			        	document.getElementById("productionType").value=type;
			        	document.getElementById("productionPrice").value=price;
			        	document.getElementById("productionLowestDiscount").value=lowestDiscount;
			        	document.getElementById("productionSpecialDiscount").value=specialDiscount;
			        	$('#productionModal').modal('show');
					} else {
						var msg = data.message;
						alert(msg);
					}
				},
				dataType:"json",
        	});
        }
        
		function createGroup(){
			var groupModel = $('#groupModel').val();
			var groupPrice = $('#groupPrice').val();
			var productionRows = document.getElementById("editable");
			
			var productionReqs = new Array();
			n = 0;
			for(i = 1 ; i < productionRows.rows.length ; i++){
				if(productionRows.rows[i].cells.length > 0){
					productionReqs[n] = new Object();
					var productionModel = productionRows.rows[i].cells[0].innerHTML;
					var productionSpecialDiscount = productionRows.rows[i].cells[1].innerHTML;
					var productionNum = productionRows.rows[i].cells[2].innerHTML;
					
					productionReqs[n].model = productionModel;
					productionReqs[n].specialDiscount = parseFloat(productionSpecialDiscount);
					productionReqs[n].num = parseInt(productionNum);
					n++;
				}
			}
			
			if(!groupModel){
				alert("套系型号不能为空");
				return;
			}
			if(!groupPrice){
				alert("套系价格不能为空");
				return;
			}
			if(productionReqs.length <= 0){
				alert("套系对应单品不能为空");
				return;
			}
			
			var groupProductionReq = new Object();
			groupProductionReq.model = groupModel;
			groupProductionReq.price = parseFloat(groupPrice);
			groupProductionReq.productions = productionReqs;
			
			var data = JSON.stringify(groupProductionReq);
			var url = "/ws/group/create";
			
			$.ajax({
				async: false,
				url: url,
				type: 'POST',
				contentType: 'application/json',
				data: data,
				success: function(data, textStatus, jqXHR) {
					if(data.code == 1) {
						
						$.toast({text:'更新成功',type:'success',position:'center'});
					} else {
						var msg = data.msg;
						$.toast({text:msg,type:'danger',position:'center'});
					}
				},
				
			});
		}
    </script>

    
    

</body>

</html>
